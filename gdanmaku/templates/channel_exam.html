{% extends "base.html" %}
{% block title %}{{channel.desc}} 弹幕审核{% endblock %}

{% block body %}
<div class="row" id="danmaku-exam">
	<div class="col-md-8 col-md-offset-2">
		<h2>{{channel.desc}} 弹幕审核</h2>
		{% raw %}
		<form class="form-inline" role="form" @submit="set_exam_passwd" v-show="!exam_passwd">
			<div class="form-group">
				<input type="password" class="form-control" v-model="exam_passwd_buf" placeholder="审核密码">
				<div class="btn btn-success" @click="set_exam_passwd">保存密码</div>
			</div>
		</form>
		<div v-show="error_msg">
			<div class='alert alert-danger'>{{error_msg}}</div>
		</div>
		<div>
			<div>
				<h3>审核队列</h3>
			</div>
			<div class="row" v-for="dm in danmakus" track-by="id">
				<div class="danmaku">
					<div class="col-md-1 text-left">
						<div class="btn btn-success" @click="post_danmaku($index)" :disabled="dm.disabled">
							✓
						</div>
					</div>
					<div class="col-md-10 danmaku-text">
						{{ dm.content }}
					</div>
					<div class="col-md-1"></div>
						<div class="btn btn-danger" @click="ignore_danmaku($index)" :disabled="dm.disabled">
							&times;
						</div>
					</div>
				</div>
			</div>
		</div>
		{% endraw %}
	</div>
</div>
{% endblock %}

{% block js %}
<script type="text/javascript">

$(document).ready(function() {
	var danmakuData = {
		current_id: 0,
		danmakus: [],
		exam_passwd_buf: "",
		exam_passwd: "{{passwd}}",
		error_msg: ""
	}

	var new_danmaku = function(danmaku) {
		danmakuData.current_id++;
		danmaku.id = danmakuData.current_id;
		danmaku.disabled = false;
		danmakuData.danmakus.push(danmaku);
	}
	
	var danmakuVue = new Vue({
		el: "#danmaku-exam",
		data: danmakuData,
		methods: {
			post_danmaku: function(idx) {
				var dm = this.danmakus[idx];
				dm.disabled = true;
				this.danmakus.$set(idx, dm);

				$.ajax({
					type: "POST",
					dataType: "json",
					headers: {
						"Content-Type": "application/json",
						"X-GDANMAKU-EXAM-KEY": this.exam_passwd
					},
					url: "{{ url_for('api_post_danmaku', cname=channel.name) }}",
					data: JSON.stringify(dm),
					success: function(resp){ 
						danmakuVue.danmakus.splice(idx, 1);
					},
					statusCode: {
						403: function() {
							danmakuVue.show_error("密码有误，请刷新重设！");
						}
					}
				});
			},
			ignore_danmaku: function(idx) {
				this.danmakus.splice(idx, 1);
			},
			set_exam_passwd: function(ev) {
				ev.preventDefault();
				this.exam_passwd = this.exam_passwd_buf;
				exam_passwd = this.exam_passwd_buf;
				window.setTimeout(window.pull_danmaku, 50);
			},
			show_error: function(msg) {
				this.error_msg = msg;
			}
		}
	});

	window.pull_danmaku = function() {
		$.ajax({
			type: "GET",
			dataType: "json",
			headers: {
				"Content-Type": "application/json",
				"X-GDANMAKU-EXAM-KEY": danmakuVue.exam_passwd
			},
			url: "{{ url_for('api_danmaku_to_exam', cname=channel.name)}}",
			success: function(resp) {
				$.each(resp, function(i, dm){
					var danmaku = {
						'content': dm.text,
						'color': dm.style,
						'position': dm.position
					}
					new_danmaku(danmaku);
				});
				window.setTimeout(window.pull_danmaku, 0);
			},
			statusCode: {
				403: function() {
					danmakuVue.show_error("密码有误，请刷新重设！");
				}
			}
		});
	}
	
	if (danmakuVue.exam_passwd) {
		window.setTimeout(window.pull_danmaku, 50);
	}

});

</script>
{% endblock %}

{% block css %}
<style type="text/css">
body {
  padding-top: 40px; 
}
.danmaku-text {
	font-size: 2em;
}
</style>
{% endblock %}


{#
vim: ft=jinja
#}
